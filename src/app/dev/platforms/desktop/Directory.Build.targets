<Project>
  <Import Project="$([MSBuild]::GetPathOfFileAbove('Directory.Build.targets', '$(MSBuildThisFileDirectory)../'))" />
  
  <Target Name="ImportPluginOnBuild" BeforeTargets="CheckForDuplicateItems">
    <CallTarget Targets="ImportPlugins" />
  </Target>

  <Target Name="ImportPluginOnPublish" BeforeTargets="Publish">
    <CallTarget Targets="ImportPlugins" />
  </Target>

  <Target Name="ImportPlugins">
    <Message Text="Importing plugins in '$(PluginsInstallationFolder)'..." Importance="high" />
    
    <ItemGroup>
      <PluginNupkgFiles Include="$(PluginNupkgPath)\*.nupkg" />
    </ItemGroup>

    <MSBuild Projects="$(MSBuildProjectFile)"
             Properties="NupkgFile=%(PluginNupkgFiles.Identity)"
             Targets="UnzipNupkg"
             ContinueOnError="false"
             RunEachTargetSeparately="true">
    </MSBuild>
    
    <Message Text="Plugins imported!" Importance="high" />
  </Target>

  <Target Name="UnzipNupkg">
    <Message Text="Extracting plugin '$(NupkgFile)'..." Importance="high" />
    
    <PropertyGroup>
      <FileNameWithoutExtension>$([System.IO.Path]::GetFileNameWithoutExtension($(NupkgFile)))</FileNameWithoutExtension>
      <FileNameWithoutExtensionAndVersionNumber>$([System.String]::Copy('$(FileNameWithoutExtension)').Split('.')[0]).$([System.String]::Copy('$(FileNameWithoutExtension)').Split('.')[1])</FileNameWithoutExtensionAndVersionNumber>
    </PropertyGroup>
    
    <MakeDir Directories="$(PluginsInstallationFolder)/$(FileNameWithoutExtensionAndVersionNumber)"/>
    
    <!-- Unzip on Windows and Linux. -->
    <Unzip
      Condition="$(IsMac) != 'true'"
      SourceFiles="@(NupkgFile)"
      DestinationFolder="$(PluginsInstallationFolder)\$(FileNameWithoutExtensionAndVersionNumber)"
      SkipUnchangedFiles="true"
      OverwriteReadOnlyFiles="true"/>

    <!-- Use bash on Mac. -->
    <Exec
      Condition="$(IsWindows) != 'true'"
      Command="bash -c &quot;unzip -o $(NupkgFile) -d $(PluginsInstallationFolder)/$(FileNameWithoutExtensionAndVersionNumber) &quot;" />
  </Target>
</Project>